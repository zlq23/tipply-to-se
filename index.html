<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tipply → SE</title>
  <link href="https://api.fontshare.com/css?f%5B%5D=switzer@400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Switzer', sans-serif;
      background-color: #272a33;
      color: #E0E0E0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      word-wrap: break-word;
    }
    .container {
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    #status {
      padding: 10px;
      border-radius: 4px;
      width: 100%;
    }
    .connected {
      background-color: #2a7d4a;
      color: #ffffff;
    }
    .disconnected {
      background-color: #d9534f;
      color: #ffffff;
    }
    .hint {
      font-size: 1em;
      color: #bbb;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
    }
    #jwtDate,
    #title {
      font-weight: bold;
    }
    #jwtDate.warning {
      color: #d65f5f;
    }
    #jwtDate.expired {
      color: #d65f5f;
    }
    #jwtDate {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .refresh-link {
      color: rgb(255, 185, 128);
    }
    #avatarContainer{
        height: 40px;
        width: 40px;
        border-radius: 50%;
        overflow: hidden;
    }
    #avatar{
        height: 100%;
        width: auto;
    }
    #configBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: url('data:image/svg+xml,<svg fill="%23ffffff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="%23ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M4,13.743l-1,.579a1,1,0,0,0-.366,1.366l1.488,2.578a1,1,0,0,0,1.366.366L6.5,18.05a1.987,1.987,0,0,1,1.986,0l.02.011a1.989,1.989,0,0,1,1,1.724V21a1,1,0,0,0,1,1h3a1,1,0,0,0,1-1V19.782a1.985,1.985,0,0,1,.995-1.721l.021-.012a1.987,1.987,0,0,1,1.986,0l1.008.582a1,1,0,0,0,1.366-.366l1.488-2.578A1,1,0,0,0,21,14.322l-1-.579a1.994,1.994,0,0,1-1-1.733v-.021a1.991,1.991,0,0,1,1-1.732l1-.579a1,1,0,0,0,.366-1.366L19.876,5.734a1,1,0,0,0-1.366-.366L17.5,5.95a1.987,1.987,0,0,1-1.986,0L15.5,5.94a1.989,1.989,0,0,1-1-1.724V3a1,1,0,0,0-1-1h-3a1,1,0,0,0-1,1V4.294A1.856,1.856,0,0,1,8.57,5.9l-.153.088a1.855,1.855,0,0,1-1.853,0L5.49,5.368a1,1,0,0,0-1.366.366L2.636,8.312A1,1,0,0,0,3,9.678l1,.579A1.994,1.994,0,0,1,5,11.99v.021A1.991,1.991,0,0,1,4,13.743ZM12,9a3,3,0,1,1-3,3A3,3,0,0,1,12,9Z"></path></g></svg>');
      cursor: pointer;
      outline: none;
      border: none;
      background-repeat: no-repeat;
      background-size: contain;
      width: 20px;
      height: 20px;;
    }
    #configOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #272a33;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #configForm {
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #configForm label {
      display: block;
      margin-bottom: 5px;
    }
    #configForm input {
      width: 70%;
      height: 20px;
      background: #333;
      border: 1px solid #444;
      color: white;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    #configForm button {
      background: #2a7d4a;
      color: white;
      border: none;
      height: 30px;
      border-radius: 4px;
      cursor: pointer;
      width: 40%;
    }
  </style>
</head>
<body>
<div class="container">
    <button id="configBtn"></button>
    <div id="avatarContainer" style="display: none;">
        <img id="avatar">
    </div>
    <div id="title">Tipply + SE</div>
    <div id="jwtInfo">
    Token ważny do:
        <div id="jwtDate"></div>
    </div>
    <div id="status"></div>
    <div class="hint" id="refreshHint"></div>
</div>

<div id="configOverlay">
  <div id="configForm">
    <label for="tipplyId">Link alertów tipply:</label>
    <input type="password" id="tipplyId">
    
    <label for="seToken">SE Token:</label>
    <input type="password" id="seToken">
    
    <button id="saveConfig">Zapisz</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2.4.0/dist/socket.io.js"></script>
<script>

  function loadConfig() {
    return {
      TIPPLY_USER_ID: localStorage.getItem('tipply_user_id') || "",
      SE_JWT_TOKEN: localStorage.getItem('se_jwt_token') || "",
      CURRENCY: "PLN"
    };
  }

  function formatTipplyID(url) {
    if (!url) return null; 
    const regex = /\/([^\/]+)$/;
    const match = url.match(regex);
    return match ? match[1] : null;
  }

  function saveConfig(tipplyId, seToken) {
    localStorage.setItem('tipply_user_id', tipplyId);
    localStorage.setItem('se_jwt_token', seToken);
  }
  
  const CONFIG = loadConfig();
  const DOM = {
    jwtDate: document.getElementById('jwtDate'),
    jwtInfo: document.getElementById('jwtInfo'),
    status: document.getElementById('status'),
    refreshHint: document.getElementById('refreshHint'),
    avatar: document.getElementById('avatar'),
    avatarContainer: document.getElementById('avatarContainer'),
    configBtn: document.getElementById('configBtn'),
    configOverlay: document.getElementById('configOverlay'),
    configForm: document.getElementById('configForm'),
    tipplyIdInput: document.getElementById('tipplyId'),
    seTokenInput: document.getElementById('seToken'),
    saveConfigBtn: document.getElementById('saveConfig')
  };

  let socket = null;

  DOM.configBtn.addEventListener('click', () => {
    DOM.tipplyIdInput.value = CONFIG.TIPPLY_USER_ID;
    DOM.seTokenInput.value = CONFIG.SE_JWT_TOKEN;
    DOM.configOverlay.style.display = 'flex';
  });

  
    DOM.saveConfigBtn.addEventListener('click', () => {
        const tipplyId = DOM.tipplyIdInput.value.trim();
        const seToken = DOM.seTokenInput.value.trim();

        if (tipplyId === CONFIG.TIPPLY_USER_ID && seToken === CONFIG.SE_JWT_TOKEN) {
            DOM.configOverlay.style.display = 'none';
            return;
        }

        saveConfig(tipplyId, seToken);
        DOM.configOverlay.style.display = 'none';
        location.reload();
    });


  DOM.configOverlay.addEventListener('click', (e) => {
    if (e.target === DOM.configOverlay) {
      DOM.configOverlay.style.display = 'none';
    }
  });

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      return JSON.parse(atob(base64));
    } catch (e) {
      return null;
    }
  }

  function updateStatus(text, isConnected) {
    DOM.status.textContent = text;
    DOM.status.className = isConnected ? 'connected' : 'disconnected';
  }

  async function validateToken() {
    if (!CONFIG.SE_JWT_TOKEN) {
      updateStatus("Brak tokenu", false);
      return false;
    } else if (!CONFIG.TIPPLY_USER_ID) {
      updateStatus("Brak Tipply URL", false);
      return false;
    }

    const jwtData = parseJwt(CONFIG.SE_JWT_TOKEN);
    if (!jwtData || !jwtData.exp) {
      DOM.jwtDate.textContent = "Błędny token";
      updateStatus("Błąd tokenu", false);
      return false;
    }

    const expiryDate = new Date(jwtData.exp * 1000);
    const now = new Date();
    const diffDays = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

    DOM.jwtDate.textContent = expiryDate.toLocaleString('pl-PL');

    if (diffDays <= 0) {
      DOM.jwtDate.className = 'expired';
      DOM.jwtInfo.innerText = '';
      DOM.refreshHint.innerHTML = 'Nowy token znajdziesz tu: <span class="refresh-link">www.streamelements.com/dashboard/account/channels</span>';
      updateStatus("Token wygasł", false);
      return false;
    }

    if (diffDays <= 7) DOM.jwtDate.className = 'warning';

    try {
      const response = await fetch('https://api.streamelements.com/kappa/v2/channels/me', {
        headers: {
          'Authorization': `Bearer ${CONFIG.SE_JWT_TOKEN}`,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) throw new Error("Invalid token");
      
      const data = await response.json();
      CONFIG.SE_CHANNEL_ID = data._id; 
      
      if (data.avatar) {
        DOM.avatar.src = data.avatar;
        DOM.avatarContainer.style.display = 'block';
      }
      
      return true;
    } catch (error) {
      DOM.jwtDate.className = 'expired';
      updateStatus("Nieprawidłowy token", false);
      return false;
    }
  }

  async function sendTipToSE(tip) {
    try {
      await fetch(`https://api.streamelements.com/kappa/v2/tips/${CONFIG.SE_CHANNEL_ID}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${CONFIG.SE_JWT_TOKEN}`,
        },
        body: JSON.stringify({
          user: {
            userId: tip.id || '',
            username: tip.nickname || 'Anonymous',
            email: tip.email || 'anonymous@tipply.pl',
          },
          provider: 'tipply',
          message: formatMessageWithEmotes(tip.message) || '',
          amount: parseFloat((tip.amount / 100).toFixed(2)),
          currency: CONFIG.CURRENCY,
          imported: true,
        })
      });
    } catch (error) {
      updateStatus("Błąd wysyłania tipa", false);
    }
  }

  function formatMessageWithEmotes(message) {
    if (!message) return '';
    return message.replace(/<img[^>]*alt="([^"]*)"[^>]*>/g, function(match, altText) {
        return altText;
    });
  }

  function connectToTipply() {
    if (socket) socket.disconnect();

    socket = io(`wss://ws.tipply.pl/tip/${formatTipplyID(CONFIG.TIPPLY_USER_ID)}`, {
      path: "/socket.io",
      transports: ["websocket"]
    });

    socket.on("connect", () => {
      updateStatus("Połączono", true);
    });

    socket.on("disconnect", () => {
      updateStatus("Rozłączono", false);
    });

    socket.on("reconnecting", (attempt) => {
        updateStatus(`Próba połączenia (${attempt})`, false);
    });

    socket.on("reconnect_failed", () => {
        updateStatus("Błąd połączenia", false);
    });

    socket.on("tip", (data) => {
      const tip = JSON.parse(data);
      sendTipToSE(tip);
    });
  }

  async function init() {
    const isValid = await validateToken();
    if (isValid) {
      connectToTipply();
    }
  }

  init();
</script>
</body>
</html>
